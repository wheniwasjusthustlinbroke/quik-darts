{
  "rules": {
    "users": {
      "$userId": {
        "profile": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid === $userId",
          ".validate": "newData.hasChildren(['displayName']) && newData.child('displayName').isString() && newData.child('displayName').val().length >= 1 && newData.child('displayName').val().length <= 20"
        },
        "wallet": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": false
        },
        "transactions": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": false
        },
        "progression": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid === $userId",
          ".validate": "newData.child('xp').isNumber() && newData.child('xp').val() >= 0 && newData.child('level').isNumber() && newData.child('level').val() >= 1 && newData.child('level').val() <= 100"
        },
        "streaks": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid === $userId",
          ".validate": "newData.child('currentWinStreak').isNumber() && newData.child('currentWinStreak').val() >= 0 && newData.child('bestWinStreak').isNumber() && newData.child('bestWinStreak').val() >= 0"
        }
      }
    },
    "escrow": {
      ".read": "auth != null",
      ".write": false,
      "$escrowId": {
        ".read": "auth != null"
      }
    },
    "usedAdRewards": {
      ".read": false,
      ".write": false
    },
    "matchmaking_queue": {
      "casual": {
        ".read": "auth != null",
        ".indexOn": ["timestamp"],
        "$playerId": {
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "!newData.exists() || (newData.hasChildren(['playerId', 'name', 'flag', 'timestamp']) && newData.child('playerId').val() === $playerId && newData.child('name').isString() && newData.child('name').val().length >= 1 && newData.child('name').val().length <= 20 && newData.child('flag').isString() && newData.child('flag').val().length <= 50)"
        }
      },
      "wagered": {
        "$stakeLevel": {
          ".read": "auth != null",
          ".indexOn": ["timestamp"],
          "$playerId": {
            ".write": "auth != null && auth.uid === $playerId && auth.token.firebase.sign_in_provider != 'anonymous'",
            ".validate": "!newData.exists() || (newData.hasChildren(['playerId', 'name', 'flag', 'timestamp']) && newData.child('playerId').val() === $playerId && newData.child('name').isString() && newData.child('name').val().length >= 1 && newData.child('name').val().length <= 20 && ($stakeLevel === '50' || $stakeLevel === '100' || $stakeLevel === '500' || $stakeLevel === '2500'))"
          }
        }
      }
    },
    "games": {
      ".read": "auth != null",
      ".indexOn": ["player1/id", "createdAt"],
      "$roomId": {
        ".read": "auth != null && (data.child('player1/id').val() === auth.uid || data.child('player2/id').val() === auth.uid)",
        ".write": false,
        "player1": {
          "connected": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()"
          },
          "lastHeartbeat": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()",
            ".validate": "newData.isNumber() && newData.val() > 0"
          }
        },
        "player2": {
          "connected": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()"
          },
          "lastHeartbeat": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()",
            ".validate": "newData.isNumber() && newData.val() > 0"
          }
        },
        "wager": {
          ".read": "auth != null",
          ".write": false
        }
      }
    },
    "weekly_completions": {
      "$challengeId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".validate": "!newData.exists() || ($challengeId.matches(/^[a-zA-Z0-9_-]{1,50}$/) && newData.isNumber() && newData.val() >= 0 && newData.val() <= 100000 && (!data.exists() || newData.val() === data.val() + 1))"
      }
    },
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
