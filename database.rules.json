{
  "rules": {
    "users": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        "profile": {
          ".read": "auth != null",
          ".write": "auth != null && auth.uid === $userId",
          ".validate": "newData.hasChildren(['displayName']) && newData.child('displayName').isString() && newData.child('displayName').val().length >= 1 && newData.child('displayName').val().length <= 20 && (!newData.hasChild('flag') || (newData.child('flag').isString() && newData.child('flag').val().length <= 50)) && !newData.hasChild('admin') && !newData.hasChild('verified') && !newData.hasChild('beta_tester') && !newData.hasChild('moderator')"
        },
        "wallet": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": false
        },
        "transactions": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": false
        },
        "progression": {
          ".read": "auth != null",
          ".write": false
        },
        "streaks": {
          ".read": "auth != null",
          ".write": false
        },
        "stats": {
          ".read": "auth != null",
          ".write": false
        }
      }
    },
    "escrow": {
      ".read": false,
      ".write": false,
      "$escrowId": {
        ".read": "auth != null && (data.child('player1/userId').val() === auth.uid || data.child('player2/userId').val() === auth.uid)"
      }
    },
    "usedAdRewards": {
      ".read": false,
      ".write": false
    },
    "verifiedAdRewards": {
      ".read": false,
      ".write": false
    },
    "stripeFulfillments": {
      ".read": false,
      ".write": false
    },
    "matchmaking_queue": {
      ".read": "auth != null",
      "casual": {
        ".read": "auth != null",
        ".indexOn": ["timestamp"],
        "$playerId": {
          ".write": "auth != null && auth.uid === $playerId",
          ".validate": "!newData.exists() || (newData.hasChildren(['playerId', 'name', 'flag', 'timestamp']) && newData.child('playerId').val() === $playerId && newData.child('name').isString() && newData.child('name').val().length >= 1 && newData.child('name').val().length <= 20 && newData.child('flag').isString() && newData.child('flag').val().length <= 50 && (!newData.hasChild('level') || (newData.child('level').isNumber() && newData.child('level').val() >= 1 && newData.child('level').val() <= 999)) && (!newData.hasChild('avatarUrl') || (newData.child('avatarUrl').isString() && newData.child('avatarUrl').val().length <= 500 && newData.child('avatarUrl').val().beginsWith('https://'))))",
          "matchedGameId": {
            ".write": "auth != null",
            ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 50"
          },
          "matchedByName": {
            ".write": "auth != null",
            ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20"
          },
          "matchedByFlag": {
            ".write": "auth != null",
            ".validate": "newData.isString() && newData.val().length <= 50"
          },
          "matchedByLevel": {
            ".write": "auth != null",
            ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 999"
          },
          "matchedByAvatar": {
            ".write": "auth != null",
            ".validate": "newData.isString() && newData.val().length <= 500 && newData.val().beginsWith('https://')"
          }
        }
      },
      "wagered": {
        "$stakeLevel": {
          ".read": "auth != null",
          ".indexOn": ["timestamp"],
          "$playerId": {
            ".write": "auth != null && auth.uid === $playerId && auth.token.firebase.sign_in_provider != 'anonymous'",
            ".validate": "!newData.exists() || (newData.hasChildren(['playerId', 'name', 'flag', 'timestamp']) && newData.child('playerId').val() === $playerId && newData.child('name').isString() && newData.child('name').val().length >= 1 && newData.child('name').val().length <= 20 && newData.child('flag').isString() && newData.child('flag').val().length <= 50 && ($stakeLevel === '50' || $stakeLevel === '100' || $stakeLevel === '500' || $stakeLevel === '2500') && (!newData.hasChild('level') || (newData.child('level').isNumber() && newData.child('level').val() >= 1 && newData.child('level').val() <= 999)) && (!newData.hasChild('avatarUrl') || (newData.child('avatarUrl').isString() && newData.child('avatarUrl').val().length <= 500 && newData.child('avatarUrl').val().beginsWith('https://'))))",
            "matchedGameId": {
              ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
              ".validate": "newData.isString() && newData.val().length >= 10 && newData.val().length <= 50"
            },
            "matchedByName": {
              ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
              ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 20"
            },
            "matchedByFlag": {
              ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
              ".validate": "newData.isString() && newData.val().length <= 50"
            },
            "matchedByLevel": {
              ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
              ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 999"
            },
            "matchedByAvatar": {
              ".write": "auth != null && auth.token.firebase.sign_in_provider != 'anonymous'",
              ".validate": "newData.isString() && newData.val().length <= 500 && newData.val().beginsWith('https://')"
            }
          }
        }
      }
    },
    "games": {
      ".read": false,
      ".indexOn": ["player1/id", "createdAt"],
      "$roomId": {
        ".read": "auth != null && (data.child('player1/id').val() === auth.uid || data.child('player2/id').val() === auth.uid)",
        ".write": false,
        "player1": {
          "connected": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()"
          },
          "lastHeartbeat": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()",
            ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= now + 2000"
          }
        },
        "player2": {
          "connected": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()"
          },
          "lastHeartbeat": {
            ".write": "auth != null && auth.uid === data.parent().child('id').val()",
            ".validate": "newData.isNumber() && newData.val() > 0 && newData.val() <= now + 2000"
          }
        },
        "wager": {
          ".read": "auth != null && (root.child('games').child($roomId).child('player1/id').val() === auth.uid || root.child('games').child($roomId).child('player2/id').val() === auth.uid)",
          ".write": false
        }
      }
    },
    "weekly_completions": {
      ".read": "auth != null",
      ".write": false
    },
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
